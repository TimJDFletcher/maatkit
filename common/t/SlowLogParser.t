#!/usr/bin/perl

use strict;
use warnings FATAL => 'all';

use Test::More tests => 32;
use English qw(-no_match_vars);
use Data::Dumper;
$Data::Dumper::Quotekeys = 0;
$Data::Dumper::Sortkeys  = 1;
$Data::Dumper::Indent    = 1;

require "../SlowLogParser.pm";

my $p = new SlowLogParser;

sub run_test {
   my ( $def ) = @_;
   map     { die "What is $_ for?" }
      grep { $_ !~ m/^(?:file|result|num_events)$/ }
      keys %$def;
   my @e;
   my $num_events = 0;
   eval {
      open my $fh, "<", $def->{file} or die $OS_ERROR;
      $num_events++ while $p->parse_event($fh, undef, sub { push @e, @_ });
      close $fh;
   };
   is($EVAL_ERROR, '', "No error on $def->{file}");
   if ( defined $def->{result} ) {
      is_deeply($def->{result}, \@e, $def->{file})
         or print "Got: ", Dumper(\@e);
   }
   if ( defined $def->{num_events} ) {
      is($num_events, $def->{num_events}, "$def->{file} num_events");
   }
}

# Check that I can parse a slow log in the default slow log format.
run_test({
   file => 'samples/slow001.txt',
   result => [
      {  ts            => '071015 21:43:52',
         user          => 'root',
         host          => 'localhost',
         ip            => '',
         db            => 'test',
         arg           => 'select sleep(2) from n',
         Query_time    => 2,
         Lock_time     => 0,
         Rows_sent     => 1,
         Rows_examined => 0,
         pos_in_log    => 0,
         cmd           => 'Query',
      },
      {  ts            => '071015 21:45:10',
         db            => 'sakila',
         user          => 'root',
         host          => 'localhost',
         ip            => '',
         arg           => 'select sleep(2) from test.n',
         Query_time    => 2,
         Lock_time     => 0,
         Rows_sent     => 1,
         Rows_examined => 0,
         pos_in_log    => 359,
         cmd           => 'Query',
      },
   ],
});

# I forget what's special about this one.
run_test({
   file => 'samples/slow002.txt',
   result => [
      {  arg            => 'BEGIN',
         ts             => '071218 11:48:27',
         Disk_filesort  => 'No',
         Merge_passes   => '0',
         Full_scan      => 'No',
         Full_join      => 'No',
         Thread_id      => '10',
         Tmp_table      => 'No',
         QC_Hit         => 'No',
         Rows_examined  => '0',
         Filesort       => 'No',
         Query_time     => '0.000012',
         Disk_tmp_table => 'No',
         Rows_sent      => '0',
         Lock_time      => '0.000000',
         pos_in_log     => 0,
         cmd            => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  db        => 'db1',
         timestamp => 1197996507,
         arg       => 'update db2.tuningdetail_21_265507 n
      inner join db1.gonzo a using(gonzo) 
      set n.column1 = a.column1, n.word3 = a.word3',
         Disk_filesort  => 'No',
         Merge_passes   => '0',
         Full_scan      => 'Yes',
         Full_join      => 'No',
         Thread_id      => '10',
         Tmp_table      => 'No',
         QC_Hit         => 'No',
         Rows_examined  => '62951',
         Filesort       => 'No',
         Query_time     => '0.726052',
         Disk_tmp_table => 'No',
         Rows_sent      => '0',
         Lock_time      => '0.000091',
         pos_in_log     => 332,
         cmd            => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  timestamp => 1197996507,
         arg       => 'INSERT INTO db3.vendor11gonzo (makef, bizzle)
VALUES (\'\', \'Exact\')',
         InnoDB_IO_r_bytes     => '0',
         Merge_passes          => '0',
         Full_join             => 'No',
         InnoDB_pages_distinct => '24',
         Filesort              => 'No',
         InnoDB_queue_wait     => '0.000000',
         Rows_sent             => '0',
         Lock_time             => '0.000077',
         InnoDB_rec_lock_wait  => '0.000000',
         Full_scan             => 'No',
         Disk_filesort         => 'No',
         Thread_id             => '10',
         Tmp_table             => 'No',
         QC_Hit                => 'No',
         Rows_examined         => '0',
         InnoDB_IO_r_ops       => '0',
         Disk_tmp_table        => 'No',
         Query_time            => '0.000512',
         InnoDB_IO_r_wait      => '0.000000',
         pos_in_log            => 803,
         cmd                   => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  arg => 'UPDATE db4.vab3concept1upload
SET    vab3concept1id = \'91848182522\'
WHERE  vab3concept1upload=\'6994465\'',
         InnoDB_IO_r_bytes     => '0',
         Merge_passes          => '0',
         Full_join             => 'No',
         InnoDB_pages_distinct => '11',
         Filesort              => 'No',
         InnoDB_queue_wait     => '0.000000',
         Rows_sent             => '0',
         Lock_time             => '0.000028',
         InnoDB_rec_lock_wait  => '0.000000',
         Full_scan             => 'No',
         Disk_filesort         => 'No',
         Thread_id             => '10',
         Tmp_table             => 'No',
         QC_Hit                => 'No',
         Rows_examined         => '0',
         InnoDB_IO_r_ops       => '0',
         Disk_tmp_table        => 'No',
         Query_time            => '0.033384',
         InnoDB_IO_r_wait      => '0.000000',
         pos_in_log            => 1316,
         cmd                   => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  insert_id => 34484549,
         timestamp => 1197996507,
         arg       => 'INSERT INTO db1.conch (word3, vid83)
VALUES (\'211\', \'18\')',
         InnoDB_IO_r_bytes     => '0',
         Merge_passes          => '0',
         Full_join             => 'No',
         InnoDB_pages_distinct => '18',
         Filesort              => 'No',
         InnoDB_queue_wait     => '0.000000',
         Rows_sent             => '0',
         Lock_time             => '0.000027',
         InnoDB_rec_lock_wait  => '0.000000',
         Full_scan             => 'No',
         Disk_filesort         => 'No',
         Thread_id             => '10',
         Tmp_table             => 'No',
         QC_Hit                => 'No',
         Rows_examined         => '0',
         InnoDB_IO_r_ops       => '0',
         Disk_tmp_table        => 'No',
         Query_time            => '0.000530',
         InnoDB_IO_r_wait      => '0.000000',
         pos_in_log            => 1840,
         cmd                   => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  arg => 'UPDATE foo.bar
SET    biz = \'91848182522\'',
         InnoDB_IO_r_bytes     => '0',
         Merge_passes          => '0',
         Full_join             => 'No',
         InnoDB_pages_distinct => '18',
         Filesort              => 'No',
         InnoDB_queue_wait     => '0.000000',
         Rows_sent             => '0',
         Lock_time             => '0.000027',
         InnoDB_rec_lock_wait  => '0.000000',
         Full_scan             => 'No',
         Disk_filesort         => 'No',
         Thread_id             => '10',
         Tmp_table             => 'No',
         QC_Hit                => 'No',
         Rows_examined         => '0',
         InnoDB_IO_r_ops       => '0',
         Disk_tmp_table        => 'No',
         Query_time            => '0.000530',
         InnoDB_IO_r_wait      => '0.000000',
         pos_in_log            => 2363,
         cmd                   => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  arg => 'UPDATE bizzle.bat
SET    boop=\'bop: 899\'
WHERE  fillze=\'899\'',
         timestamp             => 1197996508,
         InnoDB_IO_r_bytes     => '0',
         Merge_passes          => '0',
         Full_join             => 'No',
         InnoDB_pages_distinct => '18',
         Filesort              => 'No',
         InnoDB_queue_wait     => '0.000000',
         Rows_sent             => '0',
         Lock_time             => '0.000027',
         InnoDB_rec_lock_wait  => '0.000000',
         Full_scan             => 'No',
         Disk_filesort         => 'No',
         Thread_id             => '10',
         Tmp_table             => 'No',
         QC_Hit                => 'No',
         Rows_examined         => '0',
         InnoDB_IO_r_ops       => '0',
         Disk_tmp_table        => 'No',
         Query_time            => '0.000530',
         InnoDB_IO_r_wait      => '0.000000',
         pos_in_log            => 2825,
         cmd                   => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
      {  arg => 'UPDATE foo.bar
SET    biz = \'91848182522\'',
         InnoDB_IO_r_bytes     => '0',
         Merge_passes          => '0',
         Full_join             => 'No',
         InnoDB_pages_distinct => '18',
         Filesort              => 'No',
         InnoDB_queue_wait     => '0.000000',
         Rows_sent             => '0',
         Lock_time             => '0.000027',
         InnoDB_rec_lock_wait  => '0.000000',
         Full_scan             => 'No',
         Disk_filesort         => 'No',
         Thread_id             => '10',
         Tmp_table             => 'No',
         QC_Hit                => 'No',
         Rows_examined         => '0',
         InnoDB_IO_r_ops       => '0',
         Disk_tmp_table        => 'No',
         Query_time            => '0.000530',
         InnoDB_IO_r_wait      => '0.000000',
         pos_in_log            => 3332,
         cmd                   => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
   ],
});

# Microsecond format.
run_test({
   file => 'samples/microslow001.txt',
   result => [
      {  ts            => '071015 21:43:52',
         user          => 'root',
         host          => 'localhost',
         ip            => '',
         arg           => "SELECT id FROM users WHERE name='baouong'",
         Query_time    => '0.000652',
         Lock_time     => '0.000109',
         Rows_sent     => 1,
         Rows_examined => 1,
         pos_in_log    => 0,
         cmd           => 'Query',
      },
      {  ts   => '071015 21:43:52',
         user => 'root',
         host => 'localhost',
         ip   => '',
         arg =>
            "INSERT IGNORE INTO articles (id, body,)VALUES(3558268,'sample text')",
         Query_time    => '0.001943',
         Lock_time     => '0.000145',
         Rows_sent     => 0,
         Rows_examined => 0,
         pos_in_log    => 183,
         cmd           => 'Query',
      },
   ],
});

# A log that starts with a blank line.
run_test(
   {  file   => 'samples/slow003.txt',
      result => [
         {  Disk_filesort  => 'No',
            Disk_tmp_table => 'No',
            Filesort       => 'No',
            Full_join      => 'No',
            Full_scan      => 'No',
            Lock_time      => '0.000000',
            Merge_passes   => '0',
            QC_Hit         => 'No',
            Query_time     => '0.000012',
            Rows_examined  => '0',
            Rows_sent      => '0',
            Thread_id      => '10',
            Tmp_table      => 'No',
            arg            => 'BEGIN',
            cmd            => 'Query',
            host           => '',
            ip             => '',
            pos_in_log     => '0',
            ts             => '071218 11:48:27',
            user           => '[SQL_SLAVE]',
         },
      ],
   }
);

run_test(
   {  file   => 'samples/slow004.txt',
      result => [
         {  Lock_time     => '0',
            Query_time    => '2',
            Rows_examined => '0',
            Rows_sent     => '1',
            arg => 'select 12_13_foo from (select 12foo from 123_bar) as 123baz',
            cmd        => 'Query',
            host       => 'localhost',
            ip         => '',
            pos_in_log => '0',
            ts         => '071015 21:43:52',
            user       => 'root'
         },
      ],
   },
);

# Check a slow log that has tabs in it.
run_test(
   {  file   => 'samples/slow005.txt',
      result => [
         {  arg            => "foo\nbar\n\t\t\t0 AS counter\nbaz",
            ts             => '071218 11:48:27',
            Disk_filesort  => 'No',
            Merge_passes   => '0',
            Full_scan      => 'No',
            Full_join      => 'No',
            Thread_id      => '10',
            Tmp_table      => 'No',
            QC_Hit         => 'No',
            Rows_examined  => '0',
            Filesort       => 'No',
            Query_time     => '0.000012',
            Disk_tmp_table => 'No',
            Rows_sent      => '0',
            Lock_time      => '0.000000',
            pos_in_log     => 0,
            cmd            => 'Query',
            user           => '[SQL_SLAVE]',
            host           => '',
            ip             => '',
         },
      ],
   }
);

# A bunch of case-sensitive and case-insensitive USE stuff.
run_test({
   file => 'samples/slow006.txt',
   result => [
      {  Disk_filesort  => 'No',
         Disk_tmp_table => 'No',
         Filesort       => 'No',
         Full_join      => 'No',
         Full_scan      => 'No',
         Lock_time      => '0.000000',
         Merge_passes   => '0',
         QC_Hit         => 'No',
         Query_time     => '0.000012',
         Rows_examined  => '0',
         Rows_sent      => '0',
         Schema         => 'foo',
         Thread_id      => '10',
         Tmp_table      => 'No',
         arg            => 'SELECT col FROM foo_tbl',
         cmd            => 'Query',
         host           => '',
         ip             => '',
         pos_in_log     => '0',
         ts             => '071218 11:48:27',
         user           => '[SQL_SLAVE]'
      },
      {  Disk_filesort  => 'No',
         Disk_tmp_table => 'No',
         Filesort       => 'No',
         Full_join      => 'No',
         Full_scan      => 'No',
         Lock_time      => '0.000000',
         Merge_passes   => '0',
         QC_Hit         => 'No',
         Query_time     => '0.000012',
         Rows_examined  => '0',
         Rows_sent      => '0',
         Schema         => 'foo',
         Thread_id      => '10',
         Tmp_table      => 'No',
         arg            => 'SELECT col FROM foo_tbl',
         cmd            => 'Query',
         host           => '',
         ip             => '',
         pos_in_log     => '363',
         ts             => '071218 11:48:57',
         user           => '[SQL_SLAVE]'
      },
      {  Disk_filesort  => 'No',
         Disk_tmp_table => 'No',
         Filesort       => 'No',
         Full_join      => 'No',
         Full_scan      => 'No',
         Lock_time      => '0.000000',
         Merge_passes   => '0',
         QC_Hit         => 'No',
         Query_time     => '0.000012',
         Rows_examined  => '0',
         Rows_sent      => '0',
         Thread_id      => '20',
         Tmp_table      => 'No',
         arg            => 'SELECT col FROM bar_tbl',
         cmd            => 'Query',
         db             => 'bar',
         host           => '',
         ip             => '',
         pos_in_log     => '725',
         ts             => '071218 11:48:57',
         user           => '[SQL_SLAVE]'
      },
      {  Disk_filesort  => 'No',
         Disk_tmp_table => 'No',
         Filesort       => 'No',
         Full_join      => 'No',
         Full_scan      => 'No',
         Lock_time      => '0.000000',
         Merge_passes   => '0',
         QC_Hit         => 'No',
         Query_time     => '0.000012',
         Rows_examined  => '0',
         Rows_sent      => '0',
         Schema         => 'bar',
         Thread_id      => '10',
         Tmp_table      => 'No',
         arg            => 'SELECT col FROM bar_tbl',
         cmd            => 'Query',
         host           => '',
         ip             => '',
         pos_in_log     => '1083',
         ts             => '071218 11:49:05',
         user           => '[SQL_SLAVE]'
      },
      {  Disk_filesort  => 'No',
         Disk_tmp_table => 'No',
         Filesort       => 'No',
         Full_join      => 'No',
         Full_scan      => 'No',
         Lock_time      => '0.000000',
         Merge_passes   => '0',
         QC_Hit         => 'No',
         Query_time     => '0.000012',
         Rows_examined  => '0',
         Rows_sent      => '0',
         Thread_id      => '20',
         Tmp_table      => 'No',
         arg            => 'SELECT col FROM bar_tbl',
         cmd            => 'Query',
         db             => 'bar',
         host           => '',
         ip             => '',
         pos_in_log     => '1445',
         ts             => '071218 11:49:07',
         user           => '[SQL_SLAVE]'
      },
      {  Disk_filesort  => 'No',
         Disk_tmp_table => 'No',
         Filesort       => 'No',
         Full_join      => 'No',
         Full_scan      => 'No',
         Lock_time      => '0.000000',
         Merge_passes   => '0',
         QC_Hit         => 'No',
         Query_time     => '0.000012',
         Rows_examined  => '0',
         Rows_sent      => '0',
         Schema         => 'foo',
         Thread_id      => '30',
         Tmp_table      => 'No',
         arg            => 'SELECT col FROM foo_tbl',
         cmd            => 'Query',
         host           => '',
         ip             => '',
         pos_in_log     => '1803',
         ts             => '071218 11:49:30',
         user           => '[SQL_SLAVE]'
      }
   ],
});

# Schema
run_test({
   file => 'samples/slow007.txt',
   result => [
      {  Schema         => 'food',
         arg            => 'SELECT fruit FROM trees',
         ts             => '071218 11:48:27',
         Disk_filesort  => 'No',
         Merge_passes   => '0',
         Full_scan      => 'No',
         Full_join      => 'No',
         Thread_id      => '3',
         Tmp_table      => 'No',
         QC_Hit         => 'No',
         Rows_examined  => '0',
         Filesort       => 'No',
         Query_time     => '0.000012',
         Disk_tmp_table => 'No',
         Rows_sent      => '0',
         Lock_time      => '0.000000',
         pos_in_log     => 0,
         cmd            => 'Query',
         user           => '[SQL_SLAVE]',
         host           => '',
         ip             => '',
      },
   ],
});

# Check for number of events to see that it doesn't just run forever
# to the end of the file without returning between events.
# Also check it parses commented event (admin cmd).
run_test({
   file => 'samples/slow008.txt',
   num_events => 3,
   result => [
      {  'Schema'        => 'db1',
         'cmd'           => 'Admin',
         'ip'            => '1.2.3.8',
         'arg'           => '# administrator command: Quit',
         'Thread_id'     => '5',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.000002',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 0,
      },
      {  'Schema'        => 'db2',
         'cmd'           => 'Query',
         'db'            => 'db',
         'ip'            => '1.2.3.8',
         arg             => 'SET NAMES utf8',
         'Thread_id'     => '6',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.000899',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 221,
      },
      {  'Schema'        => 'db2',
         'cmd'           => 'Query',
         'arg'           => 'SELECT MIN(id),MAX(id) FROM tbl',
         'ip'            => '1.2.3.8',
         'Thread_id'     => '6',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.018799',
         'Lock_time'     => '0.009453',
         'Rows_sent'     => '0',
         pos_in_log      => 435,
      },
   ],
});

# Parses commented event lines after uncommented meta-lines
run_test({
   file => 'samples/slow011.txt',
   result => [
      {  'Schema'        => 'db1',
         'arg'           => '# administrator command: Quit',
         'ip'            => '1.2.3.8',
         'Thread_id'     => '5',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.000002',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 0,
         cmd             => 'Admin',
      },
      {  'Schema'        => 'db2',
         'db'            => 'db',
         'ip'            => '1.2.3.8',
         arg             => 'SET NAMES utf8',
         'Thread_id'     => '6',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.000899',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 221,
         cmd             => 'Query',
      },
      {  'Schema'        => 'db2',
         'db'            => 'db2',
         'arg'           => '# administrator command: Quit',
         'ip'            => '1.2.3.8',
         'Thread_id'     => '7',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.018799',
         'Lock_time'     => '0.009453',
         'Rows_sent'     => '0',
         pos_in_log      => 435,
         cmd             => 'Admin',
      },
      {  'Schema'        => 'db2',
         'db'            => 'db',
         'ip'            => '1.2.3.8',
         arg             => 'SET NAMES utf8',
         'Thread_id'     => '9',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'meow',
         'Query_time'    => '0.000899',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 663,
         cmd             => 'Query',
      }
   ],
});

# events that might look like meta data
run_test({
   file => 'samples/slow012.txt',
   result => [
      {  'Schema'        => 'sab',
         'arg'           => 'SET autocommit=1',
         'ip'            => '10.1.250.19',
         'Thread_id'     => '39387',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'sabapp',
         'Query_time'    => '0.000018',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 0,
         cmd             => 'Query',
      },
      {  'Schema'        => 'sab',
         'arg'           => 'SET autocommit=1',
         'ip'            => '10.1.250.19',
         'Thread_id'     => '39387',
         'host'          => '',
         'Rows_examined' => '0',
         'user'          => 'sabapp',
         'Query_time'    => '0.000018',
         'Lock_time'     => '0.000000',
         'Rows_sent'     => '0',
         pos_in_log      => 172,
         cmd             => 'Query',
      },
   ],
});

# A pathological test case to be sure a crash doesn't happen
run_test({
   file => 'samples/slow013.txt',
   result => [
      {  'Schema'        => 'abc',
         'cmd'           => 'Query',
         'arg'           => 'SET autocommit=1',
         'ip'            => '10.1.250.19',
         'Thread_id'     => '39796',
         'host'          => '',
         'pos_in_log'    => '0',
         'Rows_examined' => '0',
         'user'          => 'foo_app',
         'Query_time'    => '0.000015',
         'Rows_sent'     => '0',
         'Lock_time'     => '0.000000'
      },
      {  'Schema'        => 'test',
         'db'            => 'test',
         'cmd'           => 'Query',
         'arg'           => 'SHOW STATUS',
         'ip'            => '10.1.12.201',
         'ts'            => '081127  8:51:20',
         'Thread_id'     => '39947',
         'host'          => '',
         'pos_in_log'    => '174',
         'Rows_examined' => '226',
         'Query_time'    => '0.149435',
         'user'          => 'mytopuser',
         'Rows_sent'     => '226',
         'Lock_time'     => '0.000070'
      },
      {  'Schema'        => 'test',
         'cmd'           => 'Admin',
         'arg'           => '# administrator command: Quit',
         'ip'            => '10.1.12.201',
         'ts'            => '081127  8:51:21',
         'Thread_id'     => '39947',
         'host'          => '',
         'pos_in_log'    => '385',
         'Rows_examined' => '0',
         'Query_time'    => '0.000005',
         'user'          => 'mytopuser',
         'Rows_sent'     => '0',
         'Lock_time'     => '0.000000'
      },
      {  'Schema'        => 'abc',
         'db'            => 'abc',
         'cmd'           => 'Query',
         'arg'           => 'SET autocommit=0',
         'ip'            => '10.1.250.19',
         'Thread_id'     => '39796',
         'host'          => '',
         'pos_in_log'    => '600',
         'Rows_examined' => '0',
         'user'          => 'foo_app',
         'Query_time'    => '0.000067',
         'Rows_sent'     => '0',
         'Lock_time'     => '0.000000'
      },
      {  'Schema'        => 'abc',
         'cmd'           => 'Query',
         'arg'           => 'commit',
         'ip'            => '10.1.250.19',
         'Thread_id'     => '39796',
         'host'          => '',
         'pos_in_log'    => '782',
         'Rows_examined' => '0',
         'user'          => 'foo_app',
         'Query_time'    => '0.000015',
         'Rows_sent'     => '0',
         'Lock_time'     => '0.000000'
      }
   ],
});

# events with a lot of headers
run_test({
   file => 'samples/slow014.txt',
   result => [
      {  ts            => '071015 21:43:52',
         cmd           => 'Query',
         user          => 'root',
         host          => 'localhost',
         ip            => '',
         db            => 'test',
         arg           => 'select sleep(2) from n',
         Query_time    => 2,
         Lock_time     => 0,
         Rows_sent     => 1,
         Rows_examined => 0,
         pos_in_log    => 0,
      },
      {  ts            => '071015 21:43:52',
         cmd           => 'Query',
         user          => 'root',
         host          => 'localhost',
         ip            => '',
         db            => 'test',
         arg           => 'select sleep(2) from n',
         Query_time    => 2,
         Lock_time     => 0,
         Rows_sent     => 1,
         Rows_examined => 0,
         pos_in_log    => 1313,
      },
   ],
});

# No error parsing truncated event with no newline
run_test({
   file => 'samples/slow015.txt',
});

# Check that issue 234 doesn't kill us (broken Query_time).
run_test({
   file => 'samples/slow017.txt',
   result => [
      {  ts            => '081116 15:07:11',
         cmd           => 'Query',
         user          => 'user',
         host          => 'host',
         ip            => '10.1.65.120',
         db            => 'mydb',
         arg           => 'SELECT * FROM mytbl',
         Query_time    => '18446744073708.796870',
         Lock_time     => '0.000036',
         Rows_sent     => 1,
         Rows_examined => 127,
         pos_in_log    => 0,
      },
   ],
});

# Test a callback chain.
my $i = 0;
my @e = ();
my $file;
my $callback1 = sub {
   my ( $event ) = @_;
   return 0 if $i >= 5;
   $event->{foo} = ++$i;
   return $event;
};
my $callback2 = sub {
   my ( $event ) = @_;
   push @e, $event;
   return $event;
};
open $file, "<", 'samples/slow001.txt' or die $OS_ERROR;
$i = 0;
1 while ( $p->parse_event( $file, undef, $callback1, $callback2 ) );
close $file;
is($e[1]->{foo}, '2', "Callback chain works", );

open $file, "<", 'samples/slow002.txt' or die $OS_ERROR;
@e = ();
$i = 0;
1 while ( $p->parse_event( $file, undef, $callback1, $callback2 ) );
close $file;
is(scalar @e, '5', "Callback chain early termination works", );
